<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的学习日志</title>
    <style>
        /* 整体页面样式 */
        body {
            font-family: 'Poppins', 'Helvetica Neue', Arial, sans-serif;
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;

            /* 亮丽的流动的动态渐变背景 */
            background: linear-gradient(135deg, #FF6B6B, #556270, #FF6B6B, #556270);
            background-size: 400% 400%;
            animation: gradientAnimation 25s ease infinite;
        }

        /* 渐变动画 */
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* 引入 Google Fonts - Poppins，一种现代字体 */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        /* 主容器 */
        .container {
            width: 90%;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            gap: 2rem;
            animation: fadeIn 1s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 标题和信息区域 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
            padding-bottom: 1rem;
        }

        .header h1 {
            font-size: 2.8rem;
            color: #34495e;
            margin: 0;
            font-weight: 700;
        }

        /* 动态日期和关怀语 */
        .info {
            display: flex;
            flex-direction: column;
            text-align: right;
            color: #888;
        }

        #current-date {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        #greeting {
            font-size: 1rem;
            font-style: italic;
        }

        /* 日志编辑区 */
        #log-editor {
            width: 100%;
            height: 400px;
            padding: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1.1rem;
            line-height: 1.8;
            resize: vertical;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }
        #log-editor:focus {
            outline: none;
            border-color: #FF6B6B;
            box-shadow: 0 0 8px rgba(255, 107, 107, 0.5);
        }

        /* 按钮区域 */
        .actions {
            display: flex;
            gap: 1.5rem;
            justify-content: flex-end;
        }
        
        .save-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .save-button-wrapper, .actions #new-btn {
            display: inline-block;
            cursor: pointer;
            padding: 0.9rem 1.8rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            color: #fff;
            border: none;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
        }

        .save-button-wrapper:hover, .actions #new-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .actions #new-btn {
            background: linear-gradient(45deg, #4ECDC4, #556270);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background-color: #fff;
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .dropdown-content button {
            color: #555;
            padding: 12px 18px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
        }
        
        .dropdown-content button:hover {
            background-color: #f5f5f5;
        }

        .dropdown-content button:active {
            background-color: #eee;
        }

        /* 显示下拉菜单 */
        .dropdown-content.show {
            display: block;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
                gap: 1.5rem;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                border-bottom: none;
                padding-bottom: 0;
            }
            .info {
                text-align: left;
            }
            .actions {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            .save-dropdown {
                width: 100%;
            }
            .save-button-wrapper {
                width: 100%;
                text-align: center;
            }
            .dropdown-content {
                bottom: auto;
                top: 100%;
                left: 0;
                width: 100%;
                margin-top: 10px;
            }
        }
    </style>
    
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <div class="container" id="printable-content">
        <div class="header">
            <h1>学习日志</h1>
            <div class="info">
                <span id="current-date"></span>
                <span id="greeting">保持好奇，每日精进！</span>
            </div>
        </div>

        <textarea id="log-editor" placeholder="在此记录你的学习内容..."></textarea>

        <div class="actions">
            <button id="new-btn">新建日志</button>
            
            <div class="save-dropdown">
                <button class="save-button-wrapper" onclick="toggleDropdown(event)">保存日志 ▼</button>
                <div id="save-options" class="dropdown-content">
                    <button id="save-txt">保存为 TXT</button>
                    <button id="save-pdf">保存为 PDF</button>
                    <button id="save-docx">保存为 Word (DOCX)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const logEditor = document.getElementById('log-editor');
            const newBtn = document.getElementById('new-btn');
            const saveTxtBtn = document.getElementById('save-txt');
            const savePdfBtn = document.getElementById('save-pdf');
            const saveDocxBtn = document.getElementById('save-docx');
            const currentDateEl = document.getElementById('current-date');

            // 格式化日期和文件名
            function getFormattedDate() {
                const now = new Date();
                const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                return now.toLocaleDateString('zh-CN', options).replace(/\//g, '-');
            }

            function getFileContent() {
                const now = new Date();
                const fileContent = `${logEditor.value}\n\n---\n修改日期: ${now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}`;
                return fileContent;
            }

            // 初始化：显示当前日期
            function updateDate() {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                currentDateEl.textContent = now.toLocaleDateString('zh-CN', options);
            }
            updateDate();

            // 新建日志功能
            newBtn.addEventListener('click', () => {
                if (logEditor.value.trim() !== '' && confirm('确定要新建日志吗？当前内容将丢失。')) {
                    logEditor.value = '';
                }
                if (logEditor.value.trim() === '') {
                    logEditor.value = `## ${new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })} 学习日志\n\n`;
                }
            });

            // TXT保存功能
            saveTxtBtn.addEventListener('click', () => {
                if (logEditor.value.trim() === '') {
                    alert('日志内容为空，无法保存！');
                    return;
                }
                const fileName = `学习日志_${getFormattedDate()}.txt`;
                const blob = new Blob([getFileContent()], { type: 'text/plain;charset=utf-8' });
                saveAs(blob, fileName);
                alert('日志已保存为 TXT 格式！');
            });
            
            // PDF保存功能 (使用html2canvas+jsPDF，最稳妥的方案)
            savePdfBtn.addEventListener('click', () => {
                if (logEditor.value.trim() === '') {
                    alert('日志内容为空，无法保存！');
                    return;
                }
                
                // 将日志内容渲染到一个隐藏的 div 中，然后截取成图片
                const logContentHtml = document.createElement('div');
                logContentHtml.style.padding = '20px';
                logContentHtml.style.fontFamily = 'Helvetica, Arial, sans-serif';
                logContentHtml.innerHTML = `
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">学习日志</div>
                    <pre style="white-space: pre-wrap; font-family: inherit; font-size: 16px;">${getFileContent()}</pre>
                `;
                document.body.appendChild(logContentHtml);

                html2canvas(logContentHtml, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgWidth = 210; // A4 纸宽度
                    const pageHeight = 297; // A4 纸高度
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    const fileName = `学习日志_${getFormattedDate()}.pdf`;
                    pdf.save(fileName);
                    
                    logContentHtml.remove();
                    alert('日志已保存为 PDF 格式！');
                }).catch(e => {
                    console.error("PDF生成失败:", e);
                    alert('PDF生成失败！请检查控制台错误信息。');
                });
            });
            
            // DOCX保存功能 (已修复)
            saveDocxBtn.addEventListener('click', async () => {
                if (logEditor.value.trim() === '') {
                    alert('日志内容为空，无法保存！');
                    return;
                }
                
                const { Document, Paragraph, TextRun, Packer } = docx;

                const fileContent = getFileContent();
                const paragraphs = fileContent.split('\n').map(line => {
                    return new Paragraph({
                        children: [
                            new TextRun(line),
                        ]
                    });
                });
                
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [
                            new Paragraph({
                                children: [new TextRun({ text: "学习日志", bold: true, size: 36 })],
                            }),
                            ...paragraphs
                        ]
                    }]
                });

                const blob = await Packer.toBlob(doc);
                const fileName = `学习日志_${getFormattedDate()}.docx`;
                saveAs(blob, fileName);
                alert('日志已保存为 Word (DOCX) 格式！');
            });
            
            // 页面加载时自动在日志区添加日期
            if (logEditor.value.trim() === '') {
                logEditor.value = `## ${new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })} 学习日志\n\n`;
            }

        });

        // 控制保存选项的下拉菜单
        function toggleDropdown(event) {
            event.stopPropagation();
            document.getElementById("save-options").classList.toggle("show");
        }
        window.onclick = function(event) {
            if (!event.target.matches('.save-button-wrapper')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }
    </script>
</body>
</html>